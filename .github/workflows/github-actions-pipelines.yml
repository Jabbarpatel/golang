name: CI/CD pipelines to build frontend and backend

on:
  push:
    tags: ["v*"]
    branches: ["main", "release/*"]

jobs:
  build-frontend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up Bun environment
        uses: oven-sh/setup-bun@v1

      - name: Install frontend dependancy
        working-directory: ./development/frontend
        run: bun install

      - name: Frontend lint errors
        working-directory: ./development/frontend
        run: bun lint

      - name: Frontend typescript errors
        working-directory: ./development/frontend
        run: bun tsc

  build-docker-images:
    needs:
      - build-frontend
    runs-on: ubuntu-latest
    env:
      FRONTEND_DEV_IMAGE: jabbarpatel/yellow-book-development-frontend
      BACKEND_DEV_IMAGE: jabbarpatel/yellow-book-development-backend
      FRONTEND_PRO_IMAGE: jabbarpatel/yellow-book-production-frontend
      BACKEND_PRO_IMAGE: jabbarpatel/yellow-book-production-backend

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Login to docker HUB
        if: startsWith(github.ref, 'refs/tags/v')
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Push frontend and backend image to docker HUB
        if: startsWith(github.ref, 'refs/tags/v')
        run: |

          TAG=${GITHUB_REF_NAME}
          if [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]];then
            echo "Detected PRO tag: $TAG"
            FRONTEND_IMAGE=$FRONTEND_PRO_IMAGE
            BACKEND_IMAGE=$BACKEND_PRO_IMAGE
            TARGET="prod"
          elif [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-dev$ ]];then
            echo "Detected DEV tag: $TAG"
            FRONTEND_IMAGE=$FRONTEND_DEV_IMAGE
            BACKEND_IMAGE=$BACKEND_DEV_IMAGE
            TARGET="dev"
          else
            echo "Invalid tag format: $TAG"
            exit 1
          fi

          docker build --target $TARGET -t $FRONTEND_IMAGE:${GITHUB_REF_NAME} -f ./development/frontend/dockerfile ./development
          docker push $FRONTEND_IMAGE:${GITHUB_REF_NAME}
          docker build --target $TARGET -t $BACKEND_IMAGE:${GITHUB_REF_NAME} -f ./development/backend/dockerfile ./development
          docker push $BACKEND_IMAGE:${GITHUB_REF_NAME}
